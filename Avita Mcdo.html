<!DOCTYPE html>
<html>
<head>
    <title>Avita - Suivi des Pertes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <style>
        /* styles CSS */
        :root {
            --primary-color: #2A3447;
            --secondary-color: #DA291C;
            --background-color: #1E2738;
            --text-color: #E0E0E0;
            --category-color: #FFC72C;
            --print-button-color: #4CAF50;
            --admin-panel-color: #34495E;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .header-title {
            flex-grow: 1;
            text-align: center;
        }

        .admin-indicator {
            position: absolute;
            right: 1rem;
        }

        .admin-login-button {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background-color: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            justify-content: center;
            max-width: 900px;
            width: 100%;
        }

        .category {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .category-icon {
            width: 100px;
            height: 100px;
            background-color: var(--category-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .category-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(255,255,255,0.2);
        }

        .category-name {
            font-size: 1.1rem;
            text-align: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .footer {
            background-color: var(--primary-color);
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .footer select, .footer button, .footer input[type="date"] {
            padding: 0.7rem 1rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        .footer select {
            background-color: var(--category-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .footer select:focus, .footer input[type="date"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--secondary-color);
        }

        .footer button {
            background-color: var(--secondary-color);
            color: white;
        }

        .footer button:hover {
            opacity: 0.9;
        }

        #printButton {
            background-color: var(--print-button-color);
        }

        #adminLogin {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .admin-login-content {
            background-color: var(--admin-panel-color);
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: var(--text-color);
            width: 300px;
            position: relative;
        }

        .admin-login-content h2 {
            margin-top: 0;
            text-align: center;
        }

        .admin-login-content input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: none;
            border-radius: 5px;
        }

        .admin-login-content .login-btn {
            width: 100%;
            padding: 0.7rem;
            background-color: var(--print-button-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .admin-login-content .login-btn:hover {
            background-color: #3e8e41;
        }

        .admin-login-content .close-btn {
            width: 100%;
            padding: 0.7rem;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: background-color 0.3s;
        }

        .admin-login-content .close-btn:hover {
            background-color: #B5231B;
        }

        .product-page {
            display: none;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--background-color);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .product-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 1rem;
            max-width: 100%;
            box-sizing: border-box;
        }

        .product-item {
            background-color: #2A3447;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem;
            width: calc(25% - 1rem);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .product-item:hover {
            background-color: #3A4457;
        }

        .product-name {
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
        }

        .product-controls {
            display: flex;
            align-items: center;
        }

        .product-count {
            margin: 0 0.5rem;
            min-width: 1.5rem;
            text-align: center;
            color: var(--text-color);
        }

        .back-button {
            padding: 0.5rem 1rem;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            background-color: var(--admin-panel-color);
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            padding: 1rem;
            overflow-y: auto;
            color: var(--text-color);
            z-index: 1001;
            max-height: 100vh;
        }

        .admin-panel h2 {
            margin-top: 0;
            text-align: center;
            font-size: 1.2rem;
        }

        .admin-controls {
            margin-top: 1rem;
        }

        .admin-controls button {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .admin-controls button:hover {
            background-color: #B5231B;
        }

        .admin-indicator {
            display: none;
            background-color: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .control-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .control-button:hover {
            background-color: var(--secondary-color);
        }

        .category-header {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 1rem;
            background-color: var(--primary-color);
            color: white;
        }

        .category-title {
            font-size: 1.5rem;
            font-weight: bold;
            flex-grow: 1;
            text-align: center;
        }

        .product-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .product-modal-content {
            background-color: var(--admin-panel-color);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }

        .product-modal-content h2 {
            margin-top: 0;
        }

        .product-modal-content input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: none;
            border-radius: 5px;
        }

        .product-modal-content select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: none;
            border-radius: 5px;
        }

        .product-modal-content button {
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .product-modal-content .save-btn {
            background-color: var(--print-button-color);
            color: white;
        }

        .product-modal-content .delete-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .product-modal-content .cancel-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .add-product-form {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
        }

        .add-product-form input, .add-product-form select {
            padding: 0.5rem;
            margin-right: 0.5rem;
            border: none;
            border-radius: 5px;
        }

        .add-product-form button {
            padding: 0.5rem 1rem;
            background-color: var(--print-button-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-bar {
            margin: 10px;
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .search-bar input {
            width: 80%;
            max-width: 500px;
            padding: 10px 40px 10px 10px;
            font-size: 16px;
            border-radius: 25px;
            border: 1px solid #ccc;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>');
            background-repeat: no-repeat;
            background-position: calc(100% - 10px) center;
            background-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
            position: relative;
        }

        .search-bar input:focus {
            outline: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .suggestions {
            position: absolute;
            background-color: var(--background-color);
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            width: 80%;
            max-width: 500px;
            margin-top: 10px;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: var(--primary-color);
        }

        .sub-product-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 1rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .sub-product-item {
            background-color: #34495E;
            border-radius: 5px;
            padding: 0.5rem;
            margin: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: calc(50% - 1rem);
            max-width: 300px;
        }

        .sub-product-name {
            font-size: 1rem;
            color: var(--text-color);
        }

        #subProductPage {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 768px) {
            .sub-product-item {
                width: calc(100% - 1rem);
            }
        }

        .calendar-container {
            display: none;
        }

        @media (max-width: 768px) {
            .product-item {
                width: calc(50% - 1rem);
            }
        }

        @media (max-width: 480px) {
            .product-item {
                width: calc(100% - 1rem);
            }
        }

        .calendar-container input[type="date"] {
            padding: 0.7rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 5px;
            background-color: var(--category-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .close-btn-admin {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .close-btn-admin:hover {
            background-color: #B5231B;
        }

        .report-page {
            display: none;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--background-color);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
        }

        .report-content {
            background-color: var(--admin-panel-color);
            padding: 1rem;
            border-radius: 10px;
            color: var(--text-color);
            max-width: 800px;
            margin: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .report-content h2 {
            text-align: center;
        }

        .report-content button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 1rem auto 0 auto;
            transition: background-color 0.3s;
        }

        .report-content button:hover {
            background-color: #B5231B;
        }

        #adminPanelToggle {
    display: none;
    position: fixed;
    top: 10px;
    right: 10px;
    background-color: var(--secondary-color);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    z-index: 1002;
    font-size: 1rem;
}

#adminPanelToggle:hover {
    background-color: #B5231B;
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <span id="headerTitle">Avita - Suivi des pertes du </span>
                <span id="currentDate"></span>
            </div>
            <span class="admin-indicator" id="adminIndicator">Panel Admin</span>
            <button class="admin-login-button" id="adminLoginButton" onclick="showAdminLogin()">Connexion Admin</button>
        </div>
        <div class="main-content">
            <div class="category-grid" id="categoryGrid">
                <!-- Les catégories seront ajoutées dynamiquement ici -->
            </div>
        </div>
        <div class="footer">
            <select id="cycleSelect" onchange="changeCycle()">
                <option value="Midi">Midi</option>
                <option value="Soir">Soir</option>
                <option value="Nuit">Nuit</option>
            </select>
            <input type="date" id="datePicker" onchange="updateDate()">
            <button id="printButton" onclick="printLosses()">Imprimer</button>
            <button id="reportButton" onclick="showLossReportPage()">Rapport des Pertes</button>
        </div>
    </div>
    
    <div id="adminLogin">
        <div class="admin-login-content">
            <h2>Connexion Panel Admin</h2>
            <input type="password" id="adminPassword" placeholder="Mot de passe">
            <button class="login-btn" onclick="adminLogin()">Se connecter</button>
            <button class="close-btn" onclick="closeAdminLogin()">Fermer</button>
        </div>
    </div>

    <div id="productPage" class="product-page">
        <div class="category-header">
            <button class="back-button" onclick="closeProductPage()">Retour</button>
            <span class="category-title" id="categoryTitle"></span>
        </div>
        <div class="search-bar">
            <input type="text" id="productSearch" placeholder="Rechercher un produit..." onkeyup="searchProducts()" oninput="showSuggestions()">
            <div id="suggestions" class="suggestions"></div>
        </div>
        <div id="productList" class="product-list">
            <!-- Les produits seront ajoutés dynamiquement ici -->
        </div>
        <div id="addProductForm" class="add-product-form" style="display: none;">
            <input type="text" id="newProductName" placeholder="Nom du nouveau produit">
            <select id="newProductMeasure">
                <option value="quantité">Quantité</option>
                <option value="litre">Litre</option>
                <option value="tranche">Tranche</option>
                <option value="gramme">Gramme</option>
            </select>
            <button onclick="addNewProduct()">Ajouter</button>
        </div>
    </div>

    <div id="subProductPage" class="product-page">
        <div class="category-header">
            <button class="back-button" onclick="closeSubProductPage()">Retour</button>
            <span class="category-title" id="subProductTitle"></span>
        </div>
        <div id="subProductList" class="sub-product-list">
            <!-- Les sous-produits seront ajoutés dynamiquement ici -->
        </div>
    </div>

    <div id="reportPage" class="report-page">
        <div class="report-content">
            <h2>Rapport des Pertes</h2>
            <div id="reportDetails"></div>
            <button onclick="downloadReportAsPDF()">Télécharger en PDF</button>
            <button onclick="downloadReportAsExcel()">Télécharger en Excel</button>
            <button onclick="closeReportPage()">Fermer</button>
        </div>
    </div>

    <div id="adminPanel" class="admin-panel">
        <button class="close-btn-admin" onclick="toggleAdminPanel()">✕</button>
        <h2>Panel Admin</h2>
        <div class="admin-controls">
            <button onclick="showAddCategory()">Ajouter Catégorie</button>
            <button onclick="showEditCategories()">Modifier Catégories</button>
            <button onclick="showCategoriesToEdit()">Afficher Catégories</button>
            <button onclick="deleteCategory()">Supprimer Catégorie</button>
            <button onclick="resetLosses()">Réinitialiser les Pertes</button>
            <button onclick="adminLogout()">Déconnexion</button>
        </div>
    </div>

    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <h2>Modifier Produit</h2>
            <input type="text" id="editProductName" placeholder="Nom du produit">
            <select id="editProductMeasure">
                <option value="quantité">Quantité</option>
                <option value="litre">Litre</option>
                <option value="tranche">Tranche</option>
                <option value="gramme">Gramme</option>
            </select>
            <button class="save-btn" onclick="saveProductEdit()">Sauvegarder</button>
            <button class="delete-btn" onclick="deleteProduct()">Supprimer</button>
            <button class="cancel-btn" onclick="closeProductModal()">Annuler</button>

            <h3>Ajouter Sous-produit</h3>
            <input type="text" id="newSubProductName" placeholder="Nom du sous-produit">
            <select id="newSubProductMeasure">
                <option value="quantité">Quantité</option>
                <option value="litre">Litre</option>
                <option value="tranche">Tranche</option>
                <option value="gramme">Gramme</option>
            </select>
            <button class="add-subproduct-btn" onclick="addNewSubProduct()">Ajouter Sous-produit</button>

            <h3>Liste des sous-produits</h3>
            <div id="subProductListEdit"></div>
        </div>
    </div>

    <div class="calendar-container">
        <label for="datePicker">Sélectionnez une date : </label>
        <input type="date" id="datePicker" onchange="updateDate()">
    </div>

    <div id="reportPage" class="report-page">
        <div class="report-content">
            <h2>Rapport des Pertes</h2>
            <div id="reportDetails"></div>
            <button onclick="closeReportPage()">Fermer</button>
        </div>
    </div>

    <button id="adminPanelToggle" onclick="toggleAdminPanel()">Panel Admin</button>

    <script>
        // JavaScript
        let categories = [
            { name: 'Burgers', icon: '🍔', products: [
                { name: 'Big Mac', measure: 'quantité', subProducts: [] }, 
                { name: 'Cheeseburger', measure: 'quantité', subProducts: [] }, 
                { name: 'McChicken', measure: 'quantité', subProducts: [] },
                { name: 'Nuggets', measure: 'quantité', subProducts: [
                    { name: 'Nuggets x4', measure: 'quantité' },
                    { name: 'Nuggets x6', measure: 'quantité' },
                    { name: 'Nuggets x9', measure: 'quantité' },
                    { name: 'Nuggets x20', measure: 'quantité' }
                ]}
            ], type: 'complete' },
            { name: 'Salades', icon: '🥗', products: [
                { name: 'Salade César', measure: 'quantité', subProducts: [] }, 
                { name: 'Salade Chèvre Chaud', measure: 'quantité', subProducts: [] }
            ], type: 'complete' },
            { name: 'Protéines', icon: '🥩', products: [
                { name: 'Steak', measure: 'gramme', subProducts: [] }, 
                { name: 'Poulet', measure: 'gramme', subProducts: [] }, 
                { name: 'Poisson', measure: 'gramme', subProducts: [] }
            ], type: 'vide' },
            { name: 'Ingrédients', icon: '🧅', products: [
                { name: 'Oignons', measure: 'gramme', subProducts: [] }, 
                { name: 'Tomates', measure: 'quantité', subProducts: [] }, 
                { name: 'Salade', measure: 'quantité', subProducts: [] }
            ], type: 'vide' },
            { name: 'Sauces', icon: '🧂', products: [
                { name: 'Ketchup', measure: 'litre', subProducts: [] }, 
                { name: 'Mayonnaise', measure: 'litre', subProducts: [] }, 
                { name: 'Sauce Big Mac', measure: 'litre', subProducts: [] }
            ], type: 'vide' },
            { name: 'Frites', icon: '🍟', products: [
                { name: 'Frites Moyennes', measure: 'quantité', subProducts: [] }, 
                { name: 'Frites Grandes', measure: 'quantité', subProducts: [] }
            ], type: 'complete' },
            { name: 'Pains', icon: '🍞', products: [
                { name: 'Pain Hamburger', measure: 'quantité', subProducts: [] }, 
                { name: 'Pain Big Mac', measure: 'quantité', subProducts: [] }
            ], type: 'vide' },
            { name: 'Boissons', icon: '🥤', products: [
                { name: 'Coca-Cola', measure: 'litre', subProducts: [] }, 
                { name: 'Fanta', measure: 'litre', subProducts: [] }, 
                { name: 'Sprite', measure: 'litre', subProducts: [] }
            ], type: 'complete' },
            { name: 'Desserts', icon: '🍦', products: [
                { name: 'McFlurry', measure: 'quantité', subProducts: [] }, 
                { name: 'Sundae', measure: 'quantité', subProducts: [] }, 
                { name: 'Milk-shake', measure: 'quantité', subProducts: [] }
            ], type: 'complete' },
            { name: 'McCafé', icon: '☕', products: [
                { name: 'Café', measure: 'quantité', subProducts: [] }, 
                { name: 'Cappuccino', measure: 'quantité', subProducts: [] }, 
                { name: 'Thé', measure: 'quantité', subProducts: [] }
            ], type: 'complete' },
            { name: 'Emballages', icon: '📦', products: [
                { name: 'Boîte Big Mac', measure: 'quantité', subProducts: [] }, 
                { name: 'Sac', measure: 'quantité', subProducts: [] }, 
                { name: 'Gobelet', measure: 'quantité', subProducts: [] }
            ], type: 'vide' },
            { name: 'Divers', icon: '🔄', products: [
                { name: 'Serviettes', measure: 'quantité', subProducts: [] }, 
                { name: 'Pailles', measure: 'quantité', subProducts: [] }, 
                { name: 'Couverts', measure: 'quantité', subProducts: [] }
            ], type: 'vide' }
        ];

        let losses = JSON.parse(localStorage.getItem('losses')) || {};
        let currentDate = new Date().toLocaleDateString('fr-FR');
        let currentCycle = 'Midi';
        let isAdmin = false;
        let currentEditingCategory = '';
        let currentEditingProduct = '';
        let openSubProducts = {};

        function cleanProductData() {
            categories.forEach(category => {
                category.products = category.products.filter(product => product.name && product.measure);
                category.products.forEach(product => {
                    if (product.subProducts) {
                        product.subProducts = product.subProducts.filter(subProduct => subProduct.name && subProduct.measure);
                    }
                });
            });
        }

        function initializeCategories() {
            cleanProductData();
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'category';
                div.innerHTML = `
                    <div class="category-icon" onclick="openCategory('${category.name}')">${category.icon}</div>
                    <span class="category-name">${category.name}</span>
                `;
                grid.appendChild(div);
            });
        }

        function openCategory(categoryName) {
            const category = categories.find(c => c.name === categoryName);
            document.getElementById('categoryTitle').textContent = categoryName;
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            category.products.forEach(product => {
                if (!product.name || !product.measure) return;
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                if (isAdmin) {
                    productDiv.onclick = () => showEditProductModal(categoryName, product.name);
                } else {
                    if (product.subProducts && product.subProducts.length > 0) {
                        productDiv.onclick = () => openSubProductPage(categoryName, product.name);
                    } else {
                        productDiv.onclick = () => {};
                    }
                }
                productDiv.innerHTML = `
                    <span class="product-name">${product.name}</span>
                    ${!isAdmin && (!product.subProducts || product.subProducts.length === 0) ? `
                        <div class="product-controls">
                            <button class="control-button" onclick="adjustLoss('${categoryName}', '${product.name}', -1, '${product.measure}')">-</button>
                            <span class="product-count">${getLossCount(categoryName, product.name)}</span>
                            <button class="control-button" onclick="adjustLoss('${categoryName}', '${product.name}', 1, '${product.measure}')">+</button>
                        </div>
                    ` : ''}
                `;
                productList.appendChild(productDiv);
            });
            document.getElementById('productPage').style.display = 'block';
            document.getElementById('addProductForm').style.display = isAdmin ? 'flex' : 'none';
            currentEditingCategory = categoryName;
        }

        function openSubProductPage(categoryName, productName) {
            const category = categories.find(c => c.name === categoryName);
            const product = category.products.find(p => p.name === productName);
            document.getElementById('subProductTitle').textContent = `${categoryName} - ${productName}`;
            const subProductList = document.getElementById('subProductList');
            subProductList.innerHTML = '';
            product.subProducts.forEach(subProduct => {
                const subProductDiv = document.createElement('div');
                subProductDiv.className = 'sub-product-item';
                subProductDiv.innerHTML = `
                    <span class="sub-product-name">${subProduct.name}</span>
                    <div class="product-controls">
                        <button class="control-button" onclick="adjustLoss('${categoryName}', '${subProduct.name}', -1, '${subProduct.measure}')">-</button>
                        <span class="product-count">${getLossCount(categoryName, subProduct.name)}</span>
                        <button class="control-button" onclick="adjustLoss('${categoryName}', '${subProduct.name}', 1, '${subProduct.measure}')">+</button>
                    </div>
                `;
                subProductList.appendChild(subProductDiv);
            });
            document.getElementById('productPage').style.display = 'none';
            document.getElementById('subProductPage').style.display = 'block';
        }

        function closeProductPage() {
            document.getElementById('productPage').style.display = 'none';
        }

        function closeSubProductPage() {
            document.getElementById('subProductPage').style.display = 'none';
            document.getElementById('productPage').style.display = 'block';
        }

        function getLossCount(category, product) {
            let count = (losses[currentDate] && losses[currentDate][currentCycle] && losses[currentDate][currentCycle][category] && losses[currentDate][currentCycle][category][product]) || 0;
            const categoryObj = categories.find(c => c.name === category);
            const productObj = categoryObj.products.find(p => p.name === product);
            if (productObj && productObj.measure === 'gramme') {
                return formatGrammeCount(count);
            }
            return count;
        }

        function formatGrammeCount(count) {
            let kiloPart = Math.floor(count);
            let grammePart = ((count - kiloPart) * 1000).toFixed(0);
            let formattedCount = "";

            if (kiloPart > 0) {
                formattedCount += kiloPart + 'kg';
            }

            if (grammePart > 0) {
                formattedCount += (kiloPart > 0 ? ' ' : '') + grammePart + 'g';
            }

            return formattedCount || '0g';
        }

        function adjustLoss(category, product, amount, measure) {
            if (!losses[currentDate]) losses[currentDate] = {};
            if (!losses[currentDate][currentCycle]) losses[currentDate][currentCycle] = {};
            if (!losses[currentDate][currentCycle][category]) losses[currentDate][currentCycle][category] = {};
            if (!losses[currentDate][currentCycle][category][product]) losses[currentDate][currentCycle][category][product] = 0;

            let increment = 1;
            if (measure === 'gramme') increment = 0.050;

            losses[currentDate][currentCycle][category][product] += amount * increment;
            if (losses[currentDate][currentCycle][category][product] < 0) losses[currentDate][currentCycle][category][product] = 0;

            localStorage.setItem('losses', JSON.stringify(losses));
            
            if (document.getElementById('subProductPage').style.display === 'block') {
                openSubProductPage(category, getCurrentProductName(category));
            } else {
                openCategory(category);
            }
        }

        function getCurrentProductName(categoryName) {
            const titleElement = document.getElementById('subProductTitle');
            const titleText = titleElement.textContent;
            return titleText.split(' - ')[1];
        }

        function updateDate() {
            const selectedDate = document.getElementById('datePicker').value;
            if (selectedDate) {
                currentDate = new Date(selectedDate).toLocaleDateString('fr-FR');
            } else {
                const now = new Date();
                currentDate = now.toLocaleDateString('fr-FR');
                document.getElementById('datePicker').value = now.toISOString().split('T')[0];
            }
            document.getElementById('currentDate').textContent = currentDate;
            initializeCategories();
        }

        function changeCycle() {
            currentCycle = document.getElementById('cycleSelect').value;
            initializeCategories();
        }

        function printLosses() {
            let summary = `Résumé des pertes - ${currentDate} - Cycle: ${currentCycle}\n\n`;

            summary += "Pertes Vide:\n";
            categories.filter(c => c.type === 'vide').forEach(category => {
                let categoryLosses = [];
                category.products.forEach(product => {
                    const count = getLossCount(category.name, product.name);
                    if (count !== '0g' && count !== 0) {
                        categoryLosses.push(`${product.name}: ${count}`);
                    }
                    if (product.subProducts && product.subProducts.length > 0) {
                        product.subProducts.forEach(subProduct => {
                            const subCount = getLossCount(category.name, subProduct.name);
                            if (subCount !== '0g' && subCount !== 0) {
                                categoryLosses.push(`  - ${subProduct.name}: ${subCount}`);
                            }
                        });
                    }
                });
                if (categoryLosses.length > 0) {
                    summary += `${category.name}:\n  ${categoryLosses.join(', ')}\n`;
                }
            });

            summary += "\nPertes Complete:\n";
            categories.filter(c => c.type === 'complete').forEach(category => {
                let categoryLosses = [];
                category.products.forEach(product => {
                    const count = getLossCount(category.name, product.name);
                    if (count !== '0g' && count !== 0) {
                        categoryLosses.push(`${product.name}: ${count}`);
                    }
                    if (product.subProducts && product.subProducts.length > 0) {
                        product.subProducts.forEach(subProduct => {
                            const subCount = getLossCount(category.name, subProduct.name);
                            if (subCount !== '0g' && subCount !== 0) {
                                categoryLosses.push(`  - ${subProduct.name}: ${subCount}`);
                            }
                        });
                    }
                });
                if (categoryLosses.length > 0) {
                    summary += `${category.name}:\n  ${categoryLosses.join(', ')}\n`;
                }
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Résumé des Pertes</title>');
            printWindow.document.write('<style>body { font-family: Arial, sans-serif; color: #000; } h2 { color: #000; } .category { margin-bottom: 10px; } .product { margin-left: 20px; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h1>Résumé des pertes - ${currentDate} - Cycle: ${currentCycle}</h1>`);

            printWindow.document.write('<h2>Pertes Vide:</h2>');
            categories.filter(c => c.type === 'vide').forEach(category => {
                let categoryLosses = [];
                category.products.forEach(product => {
                    const count = getLossCount(category.name, product.name);
                    if (count !== '0g' && count !== 0) {
                        categoryLosses.push(`<div class="product">${product.name}: ${count}</div>`);
                    }
                    if (product.subProducts && product.subProducts.length > 0) {
                        product.subProducts.forEach(subProduct => {
                            const subCount = getLossCount(category.name, subProduct.name);
                            if (subCount !== '0g' && subCount !== 0) {
                                categoryLosses.push(`<div class="product">  - ${subProduct.name}: ${subCount}</div>`);
                            }
                        });
                    }
                });
                if (categoryLosses.length > 0) {
                    printWindow.document.write(`<div class="category"><strong>${category.name}:</strong>${categoryLosses.join('')}</div>`);
                }
            });

            printWindow.document.write('<h2>Pertes Complete:</h2>');
            categories.filter(c => c.type === 'complete').forEach(category => {
                let categoryLosses = [];
                category.products.forEach(product => {
                    const count = getLossCount(category.name, product.name);
                    if (count !== '0g' && count !== 0) {
                        categoryLosses.push(`<div class="product">${product.name}: ${count}</div>`);
                    }
                    if (product.subProducts && product.subProducts.length > 0) {
                        product.subProducts.forEach(subProduct => {
                            const subCount = getLossCount(category.name, subProduct.name);
                            if (subCount !== '0g' && subCount !== 0) {
                                categoryLosses.push(`<div class="product">  - ${subProduct.name}: ${subCount}</div>`);
                            }
                        });
                    }
                });
                if (categoryLosses.length > 0) {
                    printWindow.document.write(`<div class="category"><strong>${category.name}:</strong>${categoryLosses.join('')}</div>`);
                }
            });

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function showLossReportPage() {
    const reportPage = document.getElementById('reportPage');
    const reportDetails = document.getElementById('reportDetails');

    let summary = `<h2>Rapport des pertes - ${currentDate} - Cycle: ${currentCycle}</h2>`;
    summary += "<h3>Pertes Vide:</h3>";

    categories.filter(c => c.type === 'vide').forEach(category => {
        let categoryLosses = [];
        category.products.forEach(product => {
            const count = getLossCount(category.name, product.name);
            if (count !== '0g' && count !== 0) {
                categoryLosses.push(`<div>${product.name}: ${count}</div>`);
            }
            // Ajouter les sous-produits
            if (product.subProducts && product.subProducts.length > 0) {
                product.subProducts.forEach(subProduct => {
                    const subCount = getLossCount(category.name, subProduct.name);
                    if (subCount !== '0g' && subCount !== 0) {
                        categoryLosses.push(`<div>  - ${subProduct.name}: ${subCount}</div>`);
                    }
                });
            }
        });
        if (categoryLosses.length > 0) {
            summary += `<div><strong>${category.name}:</strong>${categoryLosses.join('')}</div>`;
        }
    });

    summary += "<h3>Pertes Complete:</h3>";

    categories.filter(c => c.type === 'complete').forEach(category => {
        let categoryLosses = [];
        category.products.forEach(product => {
            const count = getLossCount(category.name, product.name);
            if (count !== '0g' && count !== 0) {
                categoryLosses.push(`<div>${product.name}: ${count}</div>`);
            }
            // Ajouter les sous-produits
            if (product.subProducts && product.subProducts.length > 0) {
                product.subProducts.forEach(subProduct => {
                    const subCount = getLossCount(category.name, subProduct.name);
                    if (subCount !== '0g' && subCount !== 0) {
                        categoryLosses.push(`<div>  - ${subProduct.name}: ${subCount}</div>`);
                    }
                });
            }
        });
        if (categoryLosses.length > 0) {
            summary += `<div><strong>${category.name}:</strong>${categoryLosses.join('')}</div>`;
        }
    });

    reportDetails.innerHTML = summary;
    reportPage.style.display = 'block';
}


        function closeReportPage() {
            document.getElementById('reportPage').style.display = 'none';
        }

        function showAdminLogin() {
            document.getElementById('adminLogin').style.display = 'flex';
        }

        function closeAdminLogin() {
            document.getElementById('adminLogin').style.display = 'none';
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'Mcdo2024') {
                isAdmin = true;
                document.getElementById('adminIndicator').style.display = 'inline';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPanelToggle').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminLoginButton').style.display = 'none';
            } else {
                alert('Mot de passe incorrect. Veuillez réessayer.');
            }
        }

        function adminLogout() {
            isAdmin = false;
            document.getElementById('adminIndicator').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPanelToggle').style.display = 'none';
            document.getElementById('adminLoginButton').style.display = 'block';
        }

        function showAddCategory() {
            const categoryName = prompt("Nom de la nouvelle catégorie:");
            if (!categoryName || categoryName.trim() === "") {
                alert("Le nom de la catégorie ne peut pas être vide.");
                return;
            }
            const categoryIcon = prompt("Icône de la nouvelle catégorie (emoji):");
            const categoryType = prompt("Type de la catégorie (vide ou complete):");
            if (categoryName && categoryIcon && (categoryType === 'vide' || categoryType === 'complete')) {
                categories.push({ name: categoryName.trim(), icon: categoryIcon, products: [], type: categoryType });
                initializeCategories();
                localStorage.setItem('categories', JSON.stringify(categories));
            }
        }

        function showEditCategories() {
            const categoryToEdit = prompt("Nom de la catégorie à modifier:");
            if (!categoryToEdit || categoryToEdit.trim() === "") {
                alert("Le nom de la catégorie ne peut pas être vide.");
                return;
            }
            const category = categories.find(c => c.name === categoryToEdit.trim());
            if (category) {
                const newName = prompt("Nouveau nom (laisser vide pour ne pas changer):", category.name);
                const newIcon = prompt("Nouvelle icône (laisser vide pour ne pas changer):", category.icon);
                const newType = prompt("Nouveau type (vide ou complete, laisser vide pour ne pas changer):", category.type);
                if (newName && newName.trim() !== "") category.name = newName.trim();
                if (newIcon) category.icon = newIcon;
                if (newType && (newType === 'vide' || newType === 'complete')) category.type = newType;
                initializeCategories();
                localStorage.setItem('categories', JSON.stringify(categories));
            }
        }

        function showCategoriesToEdit() {
            const categoriesList = categories.map(c => `${c.name} (${c.type})`).join(', ');
            alert(`Catégories actuelles: ${categoriesList}`);
        }

        function deleteCategory() {
            const categoryToDelete = prompt("Nom de la catégorie à supprimer:");
            if (!categoryToDelete || categoryToDelete.trim() === "") {
                alert("Le nom de la catégorie ne peut pas être vide.");
                return;
            }
            const categoryIndex = categories.findIndex(c => c.name === categoryToDelete.trim());
            if (categoryIndex !== -1) {
                categories.splice(categoryIndex, 1);
                initializeCategories();
                localStorage.setItem('categories', JSON.stringify(categories));
            } else {
                alert("Catégorie non trouvée.");
            }
        }

        function showEditProductModal(categoryName, productName) {
            currentEditingCategory = categoryName;
            const category = categories.find(c => c.name === categoryName);
            const product = category.products.find(p => p.name === productName);
            currentEditingProduct = product.name;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductMeasure').value = product.measure;
            document.getElementById('productModal').style.display = 'block';
            renderSubProducts(product.subProducts, 'subProductListEdit');
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function saveProductEdit() {
            const newProductName = document.getElementById('editProductName').value.trim();
            const newProductMeasure = document.getElementById('editProductMeasure').value;
            if (newProductName && newProductName !== "") {
                const category = categories.find(c => c.name === currentEditingCategory);
                const productIndex = category.products.findIndex(p => p.name === currentEditingProduct);
                if (productIndex !== -1) {
                    category.products[productIndex].name = newProductName;
                    category.products[productIndex].measure = newProductMeasure;
                    localStorage.setItem('categories', JSON.stringify(categories));
                    closeProductModal();
                    openCategory(currentEditingCategory);
                }
            }
        }

        function deleteProduct() {
            const category = categories.find(c => c.name === currentEditingCategory);
            const productIndex = category.products.findIndex(p => p.name === currentEditingProduct);
            if (productIndex !== -1) {
                category.products.splice(productIndex, 1);
                localStorage.setItem('categories', JSON.stringify(categories));
                closeProductModal();
                openCategory(currentEditingCategory);
            }
        }

        function addNewProduct() {
            const newProductName = document.getElementById('newProductName').value.trim();
            const newProductMeasure = document.getElementById('newProductMeasure').value;
            if (newProductName && newProductName !== "") {
                const category = categories.find(c => c.name === currentEditingCategory);
                if (category) {
                    category.products.push({ name: newProductName, measure: newProductMeasure, subProducts: [] });
                    localStorage.setItem('categories', JSON.stringify(categories));
                    document.getElementById('newProductName').value = '';
                    openCategory(currentEditingCategory);
                }
            }
        }

        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const products = document.querySelectorAll('.product-item');
            products.forEach(product => {
                const productName = product.querySelector('.product-name').textContent.toLowerCase();
                if (productName.includes(searchTerm)) {
                    product.style.display = 'flex';
                } else {
                    product.style.display = 'none';
                }
            });
        }

        function showSuggestions() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const suggestionsBox = document.getElementById('suggestions');
            suggestionsBox.innerHTML = '';
            suggestionsBox.style.display = 'none';

            if (searchTerm.length > 0) {
                const matchedProducts = [];
                categories.forEach(category => {
                    category.products.forEach(product => {
                        if (product.name.toLowerCase().includes(searchTerm)) {
                            matchedProducts.push(product.name);
                        }
                    });
                });

                matchedProducts.forEach(productName => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = productName;
                    suggestionItem.onclick = () => {
                        document.getElementById('productSearch').value = productName;
                        suggestionsBox.style.display = 'none';
                        searchProducts();
                    };
                    suggestionsBox.appendChild(suggestionItem);
                });

                suggestionsBox.style.display = 'block';
            }
        }

        function addNewSubProduct() {
            const newSubProductName = document.getElementById('newSubProductName').value.trim();
            const newSubProductMeasure = document.getElementById('newSubProductMeasure').value;
            if (newSubProductName && newSubProductName !== "") {
                const category = categories.find(c => c.name === currentEditingCategory);
                const product = category.products.find(p => p.name === currentEditingProduct);
                if (product) {
                    product.subProducts.push({ name: newSubProductName, measure: newSubProductMeasure });
                    localStorage.setItem('categories', JSON.stringify(categories));
                    renderSubProducts(product.subProducts, 'subProductListEdit');
                }
            }
        }

        function renderSubProducts(subProducts, elementId) {
            const subProductList = document.getElementById(elementId);
            subProductList.innerHTML = '';
            subProducts.forEach(subProduct => {
                const subProductDiv = document.createElement('div');
                subProductDiv.className = 'sub-product-item';
                subProductDiv.innerHTML = `
                    <span class="sub-product-name">${subProduct.name} (${subProduct.measure})</span>
                `;
                subProductList.appendChild(subProductDiv);
            });
        }

        function resetLosses() {
            if (confirm("Êtes-vous sûr de vouloir réinitialiser tous les compteurs de pertes ?")) {
                losses = {};
                localStorage.setItem('losses', JSON.stringify(losses));
                alert("Tous les compteurs de pertes ont été réinitialisés.");
                initializeCategories();
            }
        }

        function toggleAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            if (adminPanel.style.display === 'block') {
                adminPanel.style.display = 'none';
                if (isAdmin) {
                    document.getElementById('adminPanelToggle').style.display = 'block';
                }
            } else {
                adminPanel.style.display = 'block';
                document.getElementById('adminPanelToggle').style.display = 'none';
            }
        }
        function downloadReportAsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Définir les couleurs et styles
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(0); // Couleur noire pour le texte
    doc.text(`Rapport des pertes - ${currentDate} - Cycle: ${currentCycle}`, 10, 10);

    doc.setFont("Helvetica", "normal");
    doc.setFontSize(12);

    let yPosition = 20; // Position initiale pour le texte

    // Ajouter les pertes vide
    doc.setFont("Helvetica", "bold");
    doc.text('Pertes Vide:', 10, yPosition);
    yPosition += 10;
    doc.setFont("Helvetica", "normal");

    categories.filter(c => c.type === 'vide').forEach(category => {
        let categoryLosses = [];
        category.products.forEach(product => {
            const count = getLossCount(category.name, product.name);
            if (count !== '0g' && count !== 0) {
                categoryLosses.push(`${product.name}: ${count}`);
            }
            // Ajouter les sous-produits
            if (product.subProducts && product.subProducts.length > 0) {
                product.subProducts.forEach(subProduct => {
                    const subCount = getLossCount(category.name, subProduct.name);
                    if (subCount !== '0g' && subCount !== 0) {
                        categoryLosses.push(`  - ${subProduct.name}: ${subCount}`);
                    }
                });
            }
        });
        if (categoryLosses.length > 0) {
            doc.text(`${category.name}:`, 10, yPosition);
            yPosition += 10;
            categoryLosses.forEach(loss => {
                doc.text(`  ${loss}`, 10, yPosition);
                yPosition += 10;
            });
        }
    });

    // Ajouter les pertes complete
    doc.setFont("Helvetica", "bold");
    doc.text('Pertes Complete:', 10, yPosition);
    yPosition += 10;
    doc.setFont("Helvetica", "normal");

    categories.filter(c => c.type === 'complete').forEach(category => {
        let categoryLosses = [];
        category.products.forEach(product => {
            const count = getLossCount(category.name, product.name);
            if (count !== '0g' && count !== 0) {
                categoryLosses.push(`${product.name}: ${count}`);
            }
            // Ajouter les sous-produits
            if (product.subProducts && product.subProducts.length > 0) {
                product.subProducts.forEach(subProduct => {
                    const subCount = getLossCount(category.name, subProduct.name);
                    if (subCount !== '0g' && subCount !== 0) {
                        categoryLosses.push(`  - ${subProduct.name}: ${subCount}`);
                    }
                });
            }
        });
        if (categoryLosses.length > 0) {
            doc.text(`${category.name}:`, 10, yPosition);
            yPosition += 10;
            categoryLosses.forEach(loss => {
                doc.text(`  ${loss}`, 10, yPosition);
                yPosition += 10;
            });
        }
    });

    // Enregistrer le PDF avec un nom de fichier dynamique
    doc.save(`rapport_des_pertes_${currentDate}_${currentCycle}.pdf`);
}



        function downloadReportAsExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(getReportData());

            XLSX.utils.book_append_sheet(wb, ws, "Rapport des Pertes");
            XLSX.writeFile(wb, `rapport_des_pertes_${currentDate}_${currentCycle}.xlsx`);
        }

        function getReportData() {
            const reportDetails = document.getElementById('reportDetails');
            const reportLines = reportDetails.getElementsByTagName('div');
            let data = [];

            for (let i = 0; i < reportLines.length; i++) {
                const lineText = reportLines[i].innerText || reportLines[i].textContent;
                const parts = lineText.split(':');
                if (parts.length === 2) {
                    data.push({ "Produit": parts[0].trim(), "Quantité": parts[1].trim() });
                }
            }

            return data;
        }

        const now = new Date();
        document.getElementById('datePicker').value = now.toISOString().split('T')[0];
        updateDate();
        initializeCategories();

        const savedCategories = localStorage.getItem('categories');
        if (savedCategories) {
            categories = JSON.parse(savedCategories);
            initializeCategories();
        }

        setInterval(updateDate, 60000);
    </script>
</body>
</html>